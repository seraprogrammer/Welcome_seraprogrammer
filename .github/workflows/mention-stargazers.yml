name: Mention New Stargazers

on:
  schedule:
    # Runs every minute
    - cron: '* * * * *'
  workflow_dispatch: # Allows manual trigger

permissions:
  issues: write
  contents: read

jobs:
  mention-stargazers:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Fetch and Mention New Stargazers
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUBTOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const TARGET_OWNER = 'emmabostian';
            const TARGET_REPO = 'developer-portfolios';
            const TRACKING_FILE = 'mentioned-stargazers.json';
            
            // Load previously mentioned stargazers
            let mentionedUsers = [];
            try {
              if (fs.existsSync(TRACKING_FILE)) {
                const data = fs.readFileSync(TRACKING_FILE, 'utf8');
                mentionedUsers = JSON.parse(data);
              }
            } catch (error) {
              console.log('No previous tracking file found, starting fresh');
            }
            
            // Fetch recent stargazers (last 30)
            let stargazers = [];
            try {
              const response = await github.rest.activity.listStargazersForRepo({
                owner: TARGET_OWNER,
                repo: TARGET_REPO,
                per_page: 30,
                headers: {
                  Accept: 'application/vnd.github.v3.star+json'
                }
              });
              stargazers = response.data;
            } catch (error) {
              console.log('Error fetching stargazers:', error.message);
              return;
            }
            
            // Find new stargazers
            const newStargazers = stargazers.filter(star => 
              !mentionedUsers.includes(star.user.login)
            );
            
            if (newStargazers.length === 0) {
              console.log('No new stargazers found');
              return;
            }
            
            console.log(`Found ${newStargazers.length} new stargazer(s)`);
            
            // Create issue for each new stargazer
            for (const star of newStargazers) {
              const username = star.user.login;
              const starredAt = new Date(star.starred_at).toLocaleString();
              
              try {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `New Star from @${username} ‚≠ê`,
                  body: `## üéâ New Stargazer Alert!\n\n` +
                        `Hey @${username}! Thank you for starring [${TARGET_OWNER}/${TARGET_REPO}](https://github.com/${TARGET_OWNER}/${TARGET_REPO})!\n\n` +
                        `**Starred at:** ${starredAt}\n\n` +
                        `We appreciate your support! üåü\n\n` +
                        `---\n` +
                        `*This is an automated message generated by GitHub Actions.*`,
                  labels: ['new-stargazer', 'automated']
                });
                
                console.log(`Created issue for @${username}`);
                
                // Add to mentioned list
                mentionedUsers.push(username);
              } catch (error) {
                console.log(`Error creating issue for @${username}:`, error.message);
              }
            }
            
            // Save updated tracking file
            fs.writeFileSync(TRACKING_FILE, JSON.stringify(mentionedUsers, null, 2));
            console.log(`Updated tracking file with ${mentionedUsers.length} total users`);
      
      - name: Commit tracking file
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add mentioned-stargazers.json
          git diff --quiet && git diff --staged --quiet || git commit -m "Update mentioned stargazers tracking"
          git push